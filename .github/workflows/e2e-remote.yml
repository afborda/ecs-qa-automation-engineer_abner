name: E2E Remote Tests

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy"]
    types: [completed]

jobs:
  e2e-remote:
    name: E2E Remote API
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: logging-backend/package-lock.json

      - name: Install dependencies
        run: |
          cd logging-backend
          npm ci

      - name: Run E2E Remote Tests
        id: e2e
        env:
          API_BASE: https://abnerfonseca.com.br/api
        run: |
          cd logging-backend
          npm run test:e2e:remote
        continue-on-error: true

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-remote-report
          path: logging-backend/__tests__/e2e/reports/remote/
          retention-days: 30

      - name: Notify Discord - E2E Results
        if: always()
        run: |
          if [ "${{ steps.e2e.outcome }}" == "success" ]; then
            STATUS="✅ PASSED"
            COLOR=3066993
          else
            STATUS="❌ FAILED"
            COLOR=15158332
          fi
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$STATUS"' - E2E Remote Tests",
                "description": "**Target:** abnerfonseca.com.br/api\n**Trigger:** ${{ github.event_name }}",
                "color": '"$COLOR"',
                "fields": [
                  {"name": "Report", "value": "[Download Artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
                ],
                "footer": {"text": "GitHub Actions - E2E Remote"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

  performance-remote:
    name: Performance Remote API
    runs-on: ubuntu-latest
    needs: e2e-remote

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Artillery
        run: npm install -g artillery

      - name: Run Performance Tests
        id: perf
        run: |
          mkdir -p perf/reports/remote
          artillery run perf/artillery-remote.yml --output perf/reports/remote/report-remote.json
        continue-on-error: true

      - name: Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-remote-report
          path: perf/reports/remote/
          retention-days: 30

      - name: Notify Discord - Performance Results
        if: always()
        run: |
          if [ "${{ steps.perf.outcome }}" == "success" ]; then
            STATUS="✅ PASSED"
            COLOR=3066993
          else
            STATUS="⚠️ THRESHOLD EXCEEDED"
            COLOR=16776960
          fi
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$STATUS"' - Performance Remote Tests",
                "description": "**Target:** abnerfonseca.com.br/api\n**Tool:** Artillery",
                "color": '"$COLOR"',
                "fields": [
                  {"name": "Thresholds", "value": "P50: 300ms | P95: 1500ms | P99: 3000ms", "inline": false}
                ],
                "footer": {"text": "GitHub Actions - Performance"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
