name: Deploy

on:
  workflow_run:
    workflows: ["CI Tests"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      restart_monitoring:
        description: "Forcar reinicio da stack de monitoring"
        required: false
        default: "false"
        type: boolean

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DOCKER_USER: ${{ secrets.DOCKER_HUB_USERNAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect monitoring changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            monitoring:
              - 'monitoring/**'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./logging-backend
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/logging-api:latest
            ${{ env.DOCKER_USER }}/logging-api:${{ github.sha }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_DEPLOY_HOST }}
          port: ${{ secrets.VPS_DEPLOY_PORT }}
          username: deploy
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          envs: DOCKER_USER,GRAFANA_PASSWORD
          script: |
            cd ~/Estudos/SAP

            echo "üõë Parando stack backend..."
            docker-compose down || true

            echo "‚¨áÔ∏è Pull da imagem nova..."
            docker pull ${DOCKER_USER}/logging-api:latest

            echo "üöÄ Subindo backend (Traefik + trust proxy)..."
            docker-compose up -d --force-recreate --remove-orphans

            MONITORING_CHANGED="${{ steps.changes.outputs.monitoring }}"
            FORCE_MONITORING="${{ github.event.inputs.restart_monitoring || 'false' }}"

            if [ "$MONITORING_CHANGED" = "true" ] || [ "$FORCE_MONITORING" = "true" ]; then
              echo "üìä Reiniciando stack de monitoring..."
              cd ~/Estudos/SAP/monitoring

              # Criar/atualizar .env com credenciais do GitHub Secrets
              echo "GRAFANA_PASSWORD=${GRAFANA_PASSWORD:-admin123456}" > .env

              # Remover containers √≥rf√£os se existirem
              docker rm -f $(docker ps -aq --filter "name=qa-grafana" --filter "status=exited") 2>/dev/null || true

              docker-compose up -d --force-recreate
            else
              echo "üìä Monitoring sem altera√ß√µes - mantendo containers atuais."
            fi

            echo "üßπ Limpando imagens antigas..."
            docker image prune -f

            echo "‚úÖ Status Backend:"
            cd ~/Estudos/SAP
            docker-compose ps

            echo "‚úÖ Status Monitoring:"
            cd ~/Estudos/SAP/monitoring
            docker-compose ps

      - name: Notify Discord - Deploy Success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL_GIT }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ Deploy Successful",
                "description": "**Repository:** ${{ github.repository }}\n**Image:** `logging-api:${{ github.sha }}`\n**Target:** abnerfonseca.com.br/api",
                "color": 3066993,
                "fields": [
                  {"name": "Docker Tag", "value": "`latest`", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}
                ],
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - Deploy Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL_GIT }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Deploy Failed",
                "description": "**Repository:** ${{ github.repository }}\n**Commit:** `${{ github.sha }}`\n**Check logs:** [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15158332,
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
