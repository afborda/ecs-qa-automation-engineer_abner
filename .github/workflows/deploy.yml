name: Deploy

on:
  workflow_run:
    workflows: ["CI Tests"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      restart_monitoring:
        description: "Forcar reinicio da stack de monitoring"
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DOCKER_USER: ${{ secrets.DOCKER_HUB_USERNAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect monitoring changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            monitoring:
              - 'monitoring/**'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./logging-backend
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/logging-api:latest
            ${{ env.DOCKER_USER }}/logging-api:${{ github.sha }}

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.DOCKER_HUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" ]; then
            echo "‚ùå Docker Hub credentials missing"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_DEPLOY_HOST }}" ] || [ -z "${{ secrets.VPS_DEPLOY_KEY }}" ]; then
            echo "‚ùå VPS deploy credentials missing"
            exit 1
          fi
          if [ -z "${{ secrets.GRAFANA_PASSWORD }}" ]; then
            echo "‚ùå GRAFANA_PASSWORD secret missing"
            exit 1
          fi
          echo "‚úÖ All required secrets present"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_DEPLOY_HOST }}
          port: ${{ secrets.VPS_DEPLOY_PORT }}
          username: deploy
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          envs: DOCKER_USER,GRAFANA_PASSWORD
          script: |
            cd ~/Estudos/SAP

            echo "‚¨áÔ∏è Pulling latest backend image..."
            docker compose pull logging-api

            echo "üöÄ Deploying backend (zero-downtime recreate)..."
            docker compose up -d --force-recreate --no-deps logging-api

            MONITORING_CHANGED="${{ steps.changes.outputs.monitoring }}"
            FORCE_MONITORING="${{ github.event.inputs.restart_monitoring || 'false' }}"

            if [ "$MONITORING_CHANGED" = "true" ] || [ "$FORCE_MONITORING" = "true" ]; then
              echo "üìä Updating monitoring stack..."
              cd ~/Estudos/SAP/monitoring

              # Validar senha obrigat√≥ria
              if [ -z "${GRAFANA_PASSWORD}" ]; then
                echo "‚ùå GRAFANA_PASSWORD not set - aborting monitoring update"
                exit 1
              fi

              # Criar/atualizar .env com credenciais do GitHub Secrets
              echo "GRAFANA_PASSWORD=${GRAFANA_PASSWORD}" > .env

              echo "‚¨áÔ∏è Pulling latest monitoring images..."
              docker compose pull

              echo "üîÑ Recreating monitoring stack (no downtime)..."
              docker compose up -d --force-recreate
            else
              echo "üìä Monitoring unchanged - skipping update."
            fi

            echo "üßπ Cleaning old images..."
            docker image prune -f

      - name: Health check - Backend API
        run: |
          echo "üè• Checking backend health..."
          echo "   Target: https://abnerfonseca.com.br/api/metrics"
          echo "   Retries: 20 attempts with 5s delay (100s total timeout)"
          
          for attempt in {1..20}; do
            echo "   Attempt $attempt/20..."
            if curl --retry 0 --connect-timeout 5 --max-time 5 -f -s https://abnerfonseca.com.br/api/metrics > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy and responding"
              exit 0
            fi
            if [ $attempt -lt 20 ]; then
              sleep 5
            fi
          done
          
          echo "‚ùå Backend health check failed after 100s - API not responding"
          echo "   Last attempt response:"
          curl -v https://abnerfonseca.com.br/api/metrics 2>&1 | head -30
            exit 1

      - name: Collect diagnostics on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_DEPLOY_HOST }}
          port: ${{ secrets.VPS_DEPLOY_PORT }}
          username: deploy
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          script: |
            echo "üìä Backend status:"
            cd ~/Estudos/SAP
            docker compose ps
            echo ""
            echo "üìã Backend logs (last 50 lines):"
            docker compose logs --tail 50 logging-api
            echo ""
            echo "üìä Monitoring status:"
            cd ~/Estudos/SAP/monitoring
            docker compose ps

      - name: Notify Discord - Deploy Success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL_GIT }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ Deploy Successful",
                "description": "**Repository:** ${{ github.repository }}\n**Image:** `logging-api:${{ github.sha }}`\n**Target:** abnerfonseca.com.br/api\n**Health:** ‚úÖ API responding",
                "color": 3066993,
                "fields": [
                  {"name": "Docker Tag", "value": "`latest`", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                  {"name": "Logs", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                ],
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - Deploy Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL_GIT }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Deploy Failed",
                "description": "**Repository:** ${{ github.repository }}\n**Commit:** `${{ github.sha }}`\n**Check logs:** [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15158332,
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
