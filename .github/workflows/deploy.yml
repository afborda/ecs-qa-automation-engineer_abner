name: Deploy

on:
  workflow_run:
    workflows: ["CI Tests"]
    types: [completed]
    branches: [main]
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DOCKER_USER: ${{ secrets.DOCKER_HUB_USERNAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./logging-backend
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/logging-api:latest
            ${{ env.DOCKER_USER }}/logging-api:${{ github.sha }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_DEPLOY_HOST }}
          port: ${{ secrets.VPS_DEPLOY_PORT }}
          username: deploy
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          envs: DOCKER_USER
          script: |
            cd ~/Estudos/SAP

            echo "Using Docker image: $DOCKER_USER/logging-api:latest"

            # Always refresh docker-compose.yml with the pushed image
            cat > docker-compose.yml << 'COMPOSE'
            version: "3.9"
            services:
              backend:
                image: afborda/logging-api:latest
                container_name: logging-api
                ports:
                  - "3000:3000"
                environment:
                  - SLOW_DEP_MS=200
                  - RATE_LIMIT=100
                restart: unless-stopped
            COMPOSE

            # Force remove old container
            docker stop logging-api 2>/dev/null || true
            docker rm logging-api 2>/dev/null || true

            # Pull and start new container
            docker pull afborda/logging-api:latest
            docker-compose up -d --force-recreate --remove-orphans
            docker image prune -f

            echo "Deploy completed. Container status:"
            docker ps | grep logging-api

      - name: Notify Discord - Deploy Success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ Deploy Successful",
                "description": "**Repository:** ${{ github.repository }}\n**Image:** `logging-api:${{ github.sha }}`\n**Target:** abnerfonseca.com.br/api",
                "color": 3066993,
                "fields": [
                  {"name": "Docker Tag", "value": "`latest`", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}
                ],
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - Deploy Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Deploy Failed",
                "description": "**Repository:** ${{ github.repository }}\n**Commit:** `${{ github.sha }}`\n**Check logs:** [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15158332,
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
