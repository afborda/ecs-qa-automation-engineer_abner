name: Deploy

on:
  workflow_run:
    workflows: ["CI Tests"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./logging-backend
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/logging-api:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/logging-api:${{ github.sha }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_DEPLOY_HOST }}
          port: ${{ secrets.VPS_DEPLOY_PORT }}
          username: deploy
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          script: |
            cd ~/Estudos/SAP
            
            # Ensure docker-compose.yml uses remote image
            if ! grep -q "image: afborda/logging-api" docker-compose.yml 2>/dev/null; then
              echo "Fixing docker-compose.yml to use remote image..."
              cat > docker-compose.yml << 'EOF'
            version: "3.9"
            services:
              backend:
                image: afborda/logging-api:latest
                container_name: logging-api
                ports:
                  - "3000:3000"
                environment:
                  - SLOW_DEP_MS=200
                  - RATE_LIMIT=100
                restart: unless-stopped
            EOF
            fi
            
            docker-compose down
            docker pull afborda/logging-api:latest
            docker-compose up -d
            docker image prune -f
            
            echo "Deploy completed. Container status:"
            docker ps | grep logging-api

      - name: Notify Discord - Deploy Success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ðŸš€ Deploy Successful",
                "description": "**Repository:** ${{ github.repository }}\n**Image:** `logging-api:${{ github.sha }}`\n**Target:** abnerfonseca.com.br/api",
                "color": 3066993,
                "fields": [
                  {"name": "Docker Tag", "value": "`latest`", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}
                ],
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'

      - name: Notify Discord - Deploy Failed
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Deploy Failed",
                "description": "**Repository:** ${{ github.repository }}\n**Commit:** `${{ github.sha }}`\n**Check logs:** [Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15158332,
                "footer": {"text": "GitHub Actions - Deploy"},
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
