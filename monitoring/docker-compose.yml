# =============================================================================
# Docker Compose - Stack de Monitoramento (com Traefik)
# =============================================================================
# Este compose sobe Prometheus, Pushgateway e Grafana para coletar métricas
# dos testes de QA e criar dashboards/alertas de regressão.
#
# Acesso externo via Traefik:
#   - Grafana:    https://abnerfonseca.com.br/grafana
#   - Prometheus: https://abnerfonseca.com.br/prometheus
#   - Pushgateway: https://abnerfonseca.com.br/push
#
# Uso: docker-compose up -d
# =============================================================================

version: "3.8"

networks:
  monitoring:
    driver: bridge
  traefik-network:
    external: true
    name: site_traefik-network

volumes:
  prometheus_data:
  grafana_data:

services:
  # ===========================================================================
  # PUSHGATEWAY - Recebe métricas de jobs efêmeros (CI/CD)
  # ===========================================================================
  pushgateway:
    image: prom/pushgateway:v1.6.2
    container_name: qa-pushgateway
    restart: unless-stopped
    networks:
      - monitoring
      - traefik-network
    ports:
      - "9091:9091"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=site_traefik-network"
      - "traefik.http.routers.pushgateway.rule=Host(`abnerfonseca.com.br`) && PathPrefix(`/push`)"
      - "traefik.http.routers.pushgateway.entrypoints=websecure"
      - "traefik.http.routers.pushgateway.tls=true"
      - "traefik.http.routers.pushgateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.pushgateway.loadbalancer.server.port=9091"
      - "traefik.http.middlewares.push-stripprefix.stripprefix.prefixes=/push"
      - "traefik.http.routers.pushgateway.middlewares=push-stripprefix"

  # ===========================================================================
  # PROMETHEUS - Coleta e armazena métricas
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: qa-prometheus
    restart: unless-stopped
    networks:
      - monitoring
      - traefik-network
    ports:
      - "9092:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=90d"
      - "--web.enable-lifecycle"
      - "--web.external-url=https://abnerfonseca.com.br/prometheus"
      - "--web.route-prefix=/"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=site_traefik-network"
      - "traefik.http.routers.prometheus.rule=Host(`abnerfonseca.com.br`) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "traefik.http.middlewares.prometheus-stripprefix.stripprefix.prefixes=/prometheus"
      - "traefik.http.routers.prometheus.middlewares=prometheus-stripprefix"

  # ===========================================================================
  # GRAFANA - Dashboards e Alertas
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: qa-grafana
    restart: unless-stopped
    networks:
      - monitoring
      - traefik-network
    ports:
      - "3100:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning:ro
      - ./dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-qaadmin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://abnerfonseca.com.br/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=site_traefik-network"
      - "traefik.http.routers.grafana.rule=Host(`abnerfonseca.com.br`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
