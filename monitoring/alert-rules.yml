# =============================================================================
# Prometheus Alert Rules - QA Automation
# =============================================================================
# Regras de alerta para detectar regressões e problemas de qualidade.
#
# Cada regra dispara quando uma condição é verdadeira por um período.
# Grafana pode consumir estes alertas ou ter seus próprios.
# =============================================================================

groups:
  - name: qa_alerts
    interval: 30s
    rules:
      # =========================================================================
      # ALERTA: Taxa de Sucesso Baixa
      # =========================================================================
      # Dispara se pass_rate < 95% por mais de 5 minutos.
      # Indica possível regressão ou bug introduzido.
      - alert: QATestPassRateLow
        expr: qa_test_pass_rate < 95
        for: 5m
        labels:
          severity: critical
          team: qa
        annotations:
          summary: "Taxa de sucesso dos testes abaixo de 95%"
          description: |
            A taxa de sucesso atual é {{ $value }}%.
            Branch: {{ $labels.branch }}
            Job: {{ $labels.job }}

            Ação: Verificar logs do CI e identificar testes falhando.

      # =========================================================================
      # ALERTA: Duração Excessiva
      # =========================================================================
      # Dispara se a suite demorar mais de 5 minutos.
      # Pode indicar testes travados ou performance degradada.
      - alert: QATestDurationHigh
        expr: qa_test_duration_seconds > 300
        for: 2m
        labels:
          severity: warning
          team: qa
        annotations:
          summary: "Suite de testes demorando mais de 5 minutos"
          description: |
            Duração atual: {{ $value }} segundos.
            Branch: {{ $labels.branch }}

            Ação: Revisar testes lentos ou possíveis deadlocks.

      # =========================================================================
      # ALERTA: Cobertura Baixa
      # =========================================================================
      # Dispara se cobertura < 60%.
      # Indica código não testado sendo adicionado.
      - alert: QATestCoverageLow
        expr: qa_test_coverage_percent < 60
        for: 5m
        labels:
          severity: warning
          team: qa
        annotations:
          summary: "Cobertura de código abaixo de 60%"
          description: |
            Cobertura atual: {{ $value }}%.
            Branch: {{ $labels.branch }}

            Ação: Adicionar testes para código não coberto.

      # =========================================================================
      # ALERTA: Testes Falhando
      # =========================================================================
      # Dispara se houver mais de 5 testes falhando.
      - alert: QATestFailuresHigh
        expr: qa_test_failed > 5
        for: 2m
        labels:
          severity: critical
          team: qa
        annotations:
          summary: "Mais de 5 testes falhando"
          description: |
            Testes falhando: {{ $value }}.
            Branch: {{ $labels.branch }}

            Ação: Revisar falhas e corrigir ou marcar como flaky.

      # =========================================================================
      # ALERTA: Pushgateway Sem Dados
      # =========================================================================
      # Dispara se não receber métricas há mais de 1 hora.
      # Indica que o CI não está rodando ou publicando.
      - alert: QAMetricsStale
        expr: time() - push_time_seconds{job="qa-tests"} > 3600
        for: 10m
        labels:
          severity: info
          team: qa
        annotations:
          summary: "Sem métricas de testes há mais de 1 hora"
          description: |
            Última atualização há {{ $value | humanizeDuration }}.

            Ação: Verificar se o CI está rodando corretamente.
